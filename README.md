# OpenSearch NL Query POC

Minimal Java example that turns natural-language questions into OpenSearch DSL using either a rule-based parser or AWS Bedrock (Claude) and then executes the DSL against an OpenSearch domain.

## Folder Structure
```
opensearch-nl-query-java/
├── pom.xml
├── README.md
├── src/
│   ├── main/
│   │   ├── java/com/opensearch/nlquery/
│   │   │   ├── App.java
│   │   │   ├── config/
│   │   │   ├── converter/
│   │   │   ├── model/
│   │   │   └── service/
│   │   └── resources/
│   │       ├── application.conf
│   │       └── logback.xml
│   └── test/ (placeholder for future tests)
├── logs/ (runtime logs, gitignored)
└── target/ (build artifacts, gitignored)
```

## Prerequisites
- Java 11+
- Maven 3.6+
- Access to an AWS OpenSearch endpoint
- AWS credentials available through the default credential chain (CLI profile, env vars, or IAM role)

## Configuration
The app reads configuration from environment variables or `src/main/resources/application.conf`.

Minimum
```bash
export OPENSEARCH_ENDPOINT="https://search-your-domain.us-east-1.es.amazonaws.com"
export AWS_REGION="us-east-1"
```

Optional Bedrock settings
```bash
export USE_LLM_CONVERSION=true
export BEDROCK_MODEL_ID=anthropic.claude-3-sonnet-20240229-v1:0
export BEDROCK_REGION=us-east-1
```

### Toggle conversion mode
- **Rule-based (default):** leave `USE_LLM_CONVERSION` unset or `false`. The app uses `RuleBasedQueryConverter` and requires no Bedrock access.
- **LLM-based:** set `USE_LLM_CONVERSION=true` plus `BEDROCK_MODEL_ID` / `BEDROCK_REGION`. The app uses AWS Bedrock (Claude) via `LLMQueryConverter`.
- Switch at runtime by exporting/unsetting the variables before launching the app.

All logs go to the console and `logs/opensearch-nl-query.log` (ignored in git).

## Quick Start
```bash
# build
mvn clean package

# run interactively
mvn exec:java -Dexec.mainClass="com.opensearch.nlquery.App"
```

## Run Health Checks / Debug Issues
- **Compile & unit checks:** `mvn clean verify`
- **Run with extra logging:** `mvn exec:java -Dexec.mainClass="com.opensearch.nlquery.App" -Dlogging.level.com.opensearch.nlquery=DEBUG`
- **Inspect logs:** `tail -f logs/opensearch-nl-query.log`
- **Validate configuration only:** `mvn exec:java -Dexec.mainClass="com.opensearch.nlquery.App" -DskipRun=true`

If Maven fails, review the console output or `target/surefire-reports`; configuration issues typically surface as missing environment variables.

## Sample Run
Example interactive session (rule-based conversion):
```bash
$ mvn exec:java -Dexec.mainClass="com.opensearch.nlquery.App"
...
=== OpenSearch Natural Language Query POC ===
Enter natural language queries (type 'exit' to quit)

Query: find documents about customer churn
[1/3] Converting natural language to OpenSearch DSL...
Generated DSL Query:
{
  "query" : {
    "bool" : {
      "must" : [
        {
          "match" : {
            "_all" : {
              "query" : "customer churn",
              "operator" : "and"
            }
          }
        }
      ]
    }
  },
  "size" : 10
}

[2/3] Executing query against AWS OpenSearch...
[3/3] Search Results:
Total hits: 2
--- Result 1 ---
Score: 1.42
ID: doc-123
Source: {"title":"Reducing Customer Churn", "status":"published"}
--- Result 2 ---
Score: 0.98
ID: doc-456
Source: {"title":"Churn Playbook", "status":"draft"}

Query: exit
```

With LLM conversion enabled (`USE_LLM_CONVERSION=true`) the DSL will be generated by Bedrock (Claude) but the execution flow is the same.

